@page "/revenuesharing"
@inherits Components.ComponentBase
@using MWRCheatSheet.Components

<Collapsable Title="Residual Income Goal" ExpandPrompt="Show me the MONEY!">
    <MudText>Monthly Income Goal: </MudText>
    <MudNumericField @bind-Value="_monthlyIncomeGoal" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.AttachMoney" Immediate="true" HelperText="Monthly Income Goal" Variant="Variant.Outlined" Min="0" Max="1000000" />
    <br />
    <br />
    <MudStack>
        <MudSpacer/>
        <MudTextField Label="Rank to Achieve" Value="@DailyGuarantee[GetRankForMonthlyIncome(_monthlyIncomeGoal)].Title" Variant="Variant.Outlined" ReadOnly="true"/>
        <MudTextField Label="Total Members" Value="@GetNumMembershipsToFundMonthlyBill(this._monthlyIncomeGoal).ToString("N0")" Variant="Variant.Outlined" ReadOnly="true"/>
        <MudTextField Label="Guaranteed Monthly Income" Value="@($"${DailyGuarantee[GetRankForMonthlyIncome(_monthlyIncomeGoal)].MonthlyPay:N0}")" Variant="Variant.Outlined" ReadOnly="true" />
        <br/>
        <br/>
        <MudText Align="Align.Center">Conservative Team Distribution</MudText>
        <br/>
        <MudTable Items="@_teamLevels" Breakpoint="Breakpoint.None" Hover="true" SortLabel="Sort By" Elevation="0">
            <HeaderContent>
                <MudTh Style="text-align:center; vertical-align:text-top; border-color:rgb(27,53,115);">Level</MudTh>
                <MudTh Style="text-align:center; vertical-align:text-top; border-color:rgb(27,53,115);">Avg QMD Enrollment</MudTh>
                <MudTh Style="text-align:center; vertical-align:top; border-color:rgb(27,53,115);">QMD Total</MudTh>
                <MudTh Style="text-align:center; vertical-align:top; border-color:rgb(27,53,115);">Customer Total</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd Style="text-align:center;" DataLabel="Level">@context.Name</MudTd>
                <MudTd Style="text-align:center;" DataLabel="Avg QMD Enrollment">@context.PersonalEnrollments.ToString("N0")</MudTd>
                <MudTd Style="text-align:center;" DataLabel="QMD Total">@context.QualifiedMarketingDirectorTotal.ToString("N0")</MudTd>
                <MudTd Style="text-align:center;" DataLabel="Customer Total">@context.CustomerTotal.ToString("N0")</MudTd>
            </RowTemplate>
        </MudTable>
        <br/>
        <MudTextField Label="Total Members" Value="@_totalMembers.ToString("N0")" Variant="Variant.Outlined" ReadOnly="true"/>
        <MudTextField Label="Guaranteed Monthly Income" Value="@($"${_monthlyIncome:N0}")" Variant="Variant.Outlined" ReadOnly="true" />
        <MudSpacer/>
    </MudStack>
</Collapsable>
<br />
<br />
<Collapsable Title="Cash Flow Equivalents">
    <MudTable Items="_cashflowEquivalents" Breakpoint="Breakpoint.None" Hover="true" SortLabel="Sort By" Elevation="0">
        <HeaderContent>
            <MudTh Style="text-align:center; vertical-align:text-top; border-color:rgb(27,53,115);">Investment <br /> @@ <br /> 5% APY</MudTh>
            <MudTh Style="text-align:center; vertical-align:top; border-color:rgb(27,53,115);">Monthly <br /> ROI</MudTh>
            <MudTh Style="text-align:center; vertical-align:top; border-color:rgb(27,53,115);">MWR <br /> Memberships</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd Style="text-align:center;" DataLabel="Investment at 5% APY">$@context.InvestmentPrinciple.ToString("N0")</MudTd>
            <MudTd Style="text-align:center;" DataLabel="Monthly ROI">$@context.MonthlyRoi.ToString("N0") <br /> ($@((context.MonthlyRoi / 30).ToString("N0"))/day)</MudTd>
            <MudTd Style="text-align:center;" DataLabel="MWR Memberships">@context.NumMemberships.ToString("N0")</MudTd>
        </RowTemplate>
    </MudTable>
</Collapsable>

@code {
    private List<TeamLevel> _teamLevels = new();
    private int _totalMembers;
    private int _monthlyIncome;

    private int _monthlyIncomeGoal;

    protected override void OnInitialized()
    {
        _teamLevels = GetTeamDistribution(QualifiedMarketingDirectorEnrollmentDistribution);
        _totalMembers = _teamLevels.Select(teamDistribution => teamDistribution.TotalMembers).Aggregate((runningTotal, next) => runningTotal + next);
        _monthlyIncome = DailyGuarantee.Reverse().First(x => x.Value.NumMemberships <= _totalMembers).Value.MonthlyPay;
    }

    private static Rank GetRankForMonthlyIncome(int monthlyIncome)
        => DailyGuarantee.First(x => x.Value.MonthlyPay >= monthlyIncome).Key;

    private static int GetNumMembershipsToFundMonthlyBill(int monthlyBillAmount)
    {
        var minimumRankToPayMonthlyBill = GetRankForMonthlyIncome(monthlyBillAmount);

        return minimumRankToPayMonthlyBill != Rank.None ? DailyGuarantee[minimumRankToPayMonthlyBill].NumMemberships : 0;
    }

    private List<CashflowEquivalent> _cashflowEquivalents = new()
    {
        new(Rank.ED1),
        new(Rank.ED2),
        new(Rank.ED3),
        new(Rank.ED4),
        new(Rank.ED5),
    };

    private static readonly Dictionary<Rank, (int NumMemberships, int MonthlyPay, string Title)> DailyGuarantee = new()
    {
        { Rank.None, (0, 0, "None") },
        { Rank.ED1, (3, 150, "Executive Director") },
        { Rank.ED2, (12, 600, "2* Executive Director") },
        { Rank.ED3, (50, 1500, "3* Executive Director") },
        { Rank.ED4, (90, 3000, "4* Executive Director") },
        { Rank.ED5, (180, 4500, "5* Executive Director") },
        { Rank.Regional1, (300, 6000, "Regional Director") },
        { Rank.Regional2, (480, 9000, "2* Regional Director") },
        { Rank.Regional3, (750, 12000, "3* Regional Director") },
        { Rank.Regional4, (1200, 19500, "4* Regional Director") },
        { Rank.Regional5, (1800, 30000, "5* Regional Director") },
        { Rank.NationalDirector, (3000, 45000, "National Director") },
        { Rank.VicePresidentialDirector, (6000, 90000, "Vice Presidential Director") },
        { Rank.PresidentialDirector, (12000, 150000, "Presidential Director") },
        { Rank.ExecutiveChairman, (21000, 300000, "Executive Chairman") },
        { Rank.NationalAmbassador, (33000, 450000, "National Ambassador") },
    };

    private readonly int[] QualifiedMarketingDirectorEnrollmentDistribution = [12, 5, 3, 2, 1];

    private static List<TeamLevel> GetTeamDistribution(int[] enrollmentDistribution)
    {
        var teamDistribution = new List<TeamLevel>();

        for (var i = 0; i < enrollmentDistribution.Length; i++)
        {
            if (i == 0)
            {
                teamDistribution.Add(new("You", enrollmentDistribution[i], null));
            }
            else
            {
                teamDistribution.Add(new($"Level {(i+1)}", enrollmentDistribution[i], teamDistribution[i-1]));
            }
        }

        return teamDistribution;
    }

    private class TeamLevel
    {
        public TeamLevel(string name, int personalEnrollments, TeamLevel? previousLevel)
        {
            this.Name = name;
            this.PersonalEnrollments = personalEnrollments;
            this.QualifiedMarketingDirectorTotal = personalEnrollments * previousLevel?.QualifiedMarketingDirectorTotal ?? personalEnrollments;
           
            // every QMD should have 1 customer
            this.CustomerTotal = this.QualifiedMarketingDirectorTotal;
        }

        public string Name { get; }
        public int PersonalEnrollments { get; }
        public int QualifiedMarketingDirectorTotal { get; }
        public int CustomerTotal { get; }
        public int TotalMembers => this.QualifiedMarketingDirectorTotal + this.CustomerTotal;
    }

    private class CashflowEquivalent
    {
        private Rank _rank;

        public CashflowEquivalent(Rank rank)
        {
            _rank = rank;
            this.InvestmentPrinciple = InvestmentCashFlowEquivalent(DailyGuarantee[_rank].MonthlyPay);
            this.MonthlyRoi = DailyGuarantee[_rank].MonthlyPay;
            this.NumMemberships = DailyGuarantee[_rank].NumMemberships;
        }

        public int InvestmentPrinciple { get; }
        public int MonthlyRoi { get; }
        public int NumMemberships { get; }

        private static int InvestmentCashFlowEquivalent(int monthlyCashFlow)
        {
            const int MonthsPerYear = 12;
            const double Apy = 0.05;

            return monthlyCashFlow * MonthsPerYear * (int)(1 / Apy);
        }
    }

    public enum Rank
    {
        None = 0,
        ED1 = 1,
        ED2 = 2,
        ED3 = 3,
        ED4 = 4,
        ED5 = 5,
        Regional1 = 6,
        Regional2 = 7,
        Regional3 = 8,
        Regional4 = 9,
        Regional5 = 10,
        NationalDirector = 11,
        VicePresidentialDirector = 12,
        PresidentialDirector = 13,
        ExecutiveChairman = 14,
        NationalAmbassador = 15,
    }
}