<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MWR Cheat Sheet</title>
    <base href="/" />
    <link rel="stylesheet" href="css/app.css" />
    <link rel="icon" type="image/png" href="favicon.png" />
    <link href="MWRCheatSheet.styles.css" rel="stylesheet" />
    <link href="manifest.webmanifest" rel="manifest" />
    <link rel="apple-touch-icon" sizes="512x512" href="icon-512.png" />
    <link rel="apple-touch-icon" sizes="192x192" href="icon-192.png" />
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" rel="stylesheet" />
    <link href="_content/MudBlazor/MudBlazor.min.css" rel="stylesheet" />
</head>

<body>
    <div id="app">
        <svg class="loading-progress">
            <circle r="40%" cx="50%" cy="50%" />
            <circle r="40%" cx="50%" cy="50%" />
        </svg>
        <div class="loading-progress-text"></div>
    </div>

    <div id="blazor-error-ui">
        An unhandled error has occurred.
        <a href="" class="reload">Reload</a>
        <a class="dismiss">ðŸ—™</a>
    </div>

    <div id="foobar">
        <img src="images/mwr-banner.png"/>
        <br/>
        <p>Hello World!</p>
    </div>

    <script src="_framework/blazor.webassembly.js"></script>
    <script src="_content/MudBlazor/MudBlazor.min.js"></script>
    <script>navigator.serviceWorker.register('service-worker.js');</script>

    <!--
        Refresh fix for Single Page Applications (SPAs)
        Source: https://github.com/orgs/community/discussions/50269
    -->
    <script type="text/javascript">
        (function (l) {
            if (l.search[1] === '/') {
                var decoded = l.search.slice(1).split('&').map(function (s) {
                    return s.replace(/~and~/g, '&')
                }).join('?');
                window.history.replaceState(null, null,
                    l.pathname.slice(0, -1) + decoded + l.hash
                );
            }
        }(window.location))
    </script>

    <script>
        async function clipboardMethod() {
            // this works perfectly on Signal Desktop

            var image = await fetch('images/mwr-banner.png');
            console.log("clipboardMethod - 1");

            var blob = await image.blob();
            console.log("clipboardMethod - 2");

            console.log("clipboardMethod - blob type: " + blob.type);

            await navigator.clipboard.write([
                new ClipboardItem({
                    [blob.type]: blob,
                    'text/plain': new Blob(["my text value"], { type: 'text/plain' })
                },
                {
                    presentationStyle : "inline"
                }),
            ]);
            console.log("clipboardMethod - 3");

        }

        async function webshare(title, message, imageUrl) {
            if (navigator.canShare) {
               var image = await fetch(imageUrl);
            
                console.log("webshareMethod - 1");

                var blob = await image.blob();

                console.log("webshareMethod - 2");

                const data = {
                    files: [
                        new File([blob], 'image.png', {
                            type: blob.type,
                        }),
                    ],
                    title: title,
                    text: message,
                };

                if (navigator.canShare(data)) {

                    console.log("webshareMethod - 3");

                    await navigator.share(data);
                }
            }
        }

        async function clipboardHTMLMethod() {
            const myContent = document.getElementById("foobar");
            const type = "text/html";
            const myBlob = new Blob([myContent.innerHTML], { type });
            console.log("clipboardHTMLMethod 1 - innerHTML: " + myContent.innerHTML);

            await navigator.clipboard.write([
                new ClipboardItem({
                    [myBlob.type]: myBlob,
                    //'text/plain': new Blob(["my text value"], { type: 'text/plain' })
                },
                    {
                        presentationStyle: "inline"
                    }),
            ]);
            console.log("clipboardHTMLMethod - 2");
        }

        window.clipboardCopy = {
            copyText: function (text) {
                navigator.clipboard.writeText(text).then(function () {
                    //alert("Copied to clipboard!");
                })
                    .catch(function (error) {
                        //alert(error);
                    });
            }
        };

        // This variable will save the event for later use.
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', async (e) => {
            // Prevents the default mini-infobar or install dialog from appearing on mobile
            e.preventDefault();

            console.log('deferredPrompt is undefined ' + (deferredPrompt === undefined));

            // Save the event because you'll need to trigger it later.
            deferredPrompt = e;
        });

        function appInstallationStatusReady() {
            return !(deferredPrompt === undefined);
        }

        function appIsInstallable() {
            return deferredPrompt != null;
        }

        async function promptToInstall() {
            // deferredPrompt is a global variable we've been using in the sample to capture the `beforeinstallevent`
            deferredPrompt.prompt();

            // Find out whether the user confirmed the installation or not
            const { outcome } = await deferredPrompt.userChoice;

            // The deferredPrompt can only be used once.
            deferredPrompt = null;

            // Act on the user's choice
            if (outcome === 'accepted') {
                console.log('User accepted the install prompt.');

                await DotNet.invokeMethodAsync("MWRCheatSheet", "OnInstallClick");
            } else if (outcome === 'dismissed') {
                console.log('User dismissed the install prompt');
            }
        }

        async function promptToInstall(componentReference) {
            // deferredPrompt is a global variable we've been using in the sample to capture the `beforeinstallevent`
            deferredPrompt.prompt();

            // Find out whether the user confirmed the installation or not
            const { outcome } = await deferredPrompt.userChoice;

            // The deferredPrompt can only be used once.
            deferredPrompt = null;

            // Act on the user's choice
            if (outcome === 'accepted') {
                console.log('User accepted the install prompt.');

                //await componentReference.invokeMethodAsync("ComponentBase", "OnAppInstalled");
                //componentReference.dispose();

                await DotNet.invokeMethodAsync("MWRCheatSheet", "OnAppInstalled");
            } else if (outcome === 'dismissed') {
                console.log('User dismissed the install prompt');
            }
        }
    </script>
</body>

</html>
